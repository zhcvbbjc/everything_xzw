è¿™ä¸ªç°è±¡**éå¸¸å…¸å‹ï¼Œè€Œä¸”ä½ å·²ç»è¸©åˆ° NTFS/MFT è¯»å–é‡Œæœ€å®¹æ˜“â€œå¡æ­»â€çš„å‘äº†**ã€‚
æˆ‘ç›´æ¥ç»™ä½ ç»“è®ºï¼Œå†é€å±‚è§£é‡Šï¼Œæœ€åç»™ä½ **å¯ä»¥ç«‹åˆ»ä¿®å¥½çš„æ–¹æ¡ˆ**ã€‚

---

## ç»“è®ºï¼ˆä¸€å¥è¯ç‰ˆï¼‰

> **ç¨‹åºä¸æ˜¯â€œåœäº†â€ï¼Œè€Œæ˜¯å¡åœ¨æŸä¸€æ¬¡ `ReadFile` ä¸Šï¼Œè¢«å†…æ ¸é˜»å¡äº†ã€‚**

æ‰€ä»¥ä½ çœ‹åˆ°çš„æ˜¯ï¼š

```
Scanned 261000 records...
ï¼ˆä¸ç»§ç»­æ‰“å°ï¼Œä¹Ÿä¸é€€å‡ºï¼‰
```

ğŸ‘‰ **è¿™æ˜¯ NTFS è¯» MFT çš„â€œå¿…ç»å‘â€ï¼Œä¸æ˜¯ä½ å†™é”™äº†ä¸šåŠ¡é€»è¾‘ã€‚**

---

## ä¸€ã€ä¸ºä»€ä¹ˆä¼šå¡åœ¨æŸä¸ª record ä¸Šï¼Ÿ

### 1ï¸âƒ£ `$MFT` â‰  è¿ç»­æ–‡ä»¶ï¼ˆè¿™æ˜¯æ ¸å¿ƒï¼‰

è™½ç„¶ `$MFT` æ˜¯â€œç³»ç»Ÿæ–‡ä»¶â€ï¼Œä½†ï¼š

* å®ƒ **å¯ä»¥è¢«ç¢ç‰‡åŒ–**
* å®ƒ **å¯ä»¥æœ‰ç¨€ç–åŒºï¼ˆholeï¼‰**
* å®ƒ **å¯ä»¥æœ‰ RunList ä¸­çš„æ— æ•ˆåŒº**

ğŸ‘‰ æŸäº› record indexï¼š

```
record_offset = m_mft_start_offset + i * record_size
```

**è½åœ¨ï¼š**

* ç¨€ç–åŒº
* æœªæ˜ å°„åŒº
* é€»è¾‘å­˜åœ¨ä½†ç‰©ç†ä¸å¯è¾¾çš„ LCN

---

### 2ï¸âƒ£ `ReadFile` åœ¨è¿™äº›åœ°æ–¹ä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ

ä¸æ˜¯ç«‹åˆ»å¤±è´¥ï¼Œè€Œæ˜¯ï¼š

* è¿›å…¥å†…æ ¸
* æ–‡ä»¶ç³»ç»Ÿå°è¯•å®šä½ç£ç›˜å—
* ç­‰å¾…åº•å±‚ I/O
* **æ°¸è¿œç­‰ä¸åˆ°**

ğŸ‘‰ **çº¿ç¨‹è¢«å†…æ ¸é˜»å¡ï¼Œä¸è¿”å›ã€ä¸æŠ¥é”™**

è¿™å°±æ˜¯ä½ ç°åœ¨çš„çŠ¶æ€ã€‚

---

## äºŒã€ä¸ºä»€ä¹ˆ Everything ä¸ä¼šå¡æ­»ï¼Ÿ

å› ä¸º Everything **ä¸è¿™ä¹ˆè¯»**ã€‚

å®ƒåšäº† 3 ä»¶ä½ ç°åœ¨è¿˜æ²¡åšçš„äº‹ï¼š

---

### âœ… 1ï¸âƒ£ ä¸ç›´æ¥é¡ºåºè¯» volume åç§»

Everythingï¼š

* å…ˆè§£æ `$MFT` çš„ **RunList**
* çŸ¥é“å“ªäº› LCN æ˜¯æœ‰æ•ˆçš„
* **åªåœ¨æœ‰æ•ˆ run é‡Œè¯»**

ä½ ç°åœ¨æ˜¯ï¼š

> â€œæˆ‘çŒœ `$MFT` æ˜¯è¿ç»­çš„â€

âŒ è¿™ä¸ªå‡è®¾åœ¨çœŸå®ç³»ç»Ÿä¸Šæ˜¯é”™çš„

---

### âœ… 2ï¸âƒ£ å¯¹ `ReadFile` åšè¶…æ—¶ / å¯ä¸­æ–­

Everythingï¼š

* ä½¿ç”¨ overlapped I/O
* æˆ–åˆ†å—é¢„è¯»
* æˆ–æœ‰ watchdog

ä½ ç°åœ¨æ˜¯ï¼š

```cpp
ReadFile(...); // åŒæ­¥é˜»å¡
```

âŒ è¿™æ˜¯â€œæ•™å­¦çº§å†™æ³•â€ï¼Œä¸æ˜¯å·¥å…·çº§

---

### âœ… 3ï¸âƒ£ æœ‰â€œæœ€å¤§è¿ç»­å¤±è´¥æ¬¡æ•°â€ä¿æŠ¤

Everything é€»è¾‘é‡Œç±»ä¼¼ï¼š

```
è¿ç»­ N æ¬¡è¯»å¤±è´¥ â†’ åœæ­¢æšä¸¾
```

ä½ ç°åœ¨æ˜¯ï¼š

```
for i < max_records â†’ æ°¸ä¸æ”¾å¼ƒ
```

---

## ä¸‰ã€ä½ ç°åœ¨ä¸ºä»€ä¹ˆåˆšå¥½å¡åœ¨ 261000ï¼Ÿ

è¿™ä¸æ˜¯éšæœºçš„ï¼ŒåŸå› é€šå¸¸æ˜¯ï¼š

* `$MFT` åˆæœŸæ˜¯è¿ç»­çš„ï¼ˆç³»ç»Ÿæ–‡ä»¶ï¼‰
* åˆ°æŸä¸ªä½ç½®å¼€å§‹ï¼š

  * è¢«æ‰©å±•è¿‡
  * è¢«ç§»åŠ¨è¿‡
  * è¢«ç¨€ç–åŒ–
* **ç¬¬ä¸€ä¸ª hole å‡ºç°çš„ä½ç½®**

ğŸ‘‰ 261k å¾ˆå¸¸è§ï¼Œå®Œå…¨åˆç†

---

## å››ã€ç«‹åˆ»å¯ç”¨çš„ä¿®æ­£æ–¹æ¡ˆï¼ˆä¸æ”¹æ¶æ„ï¼‰

ä½ ç°åœ¨**ä¸éœ€è¦ç«‹åˆ»å®ç°å®Œæ•´ RunList è§£æ**
æˆ‘ç»™ä½ ä¸€ä¸ª **Everything ä¹‹å‰ç‰ˆæœ¬ä¹Ÿç”¨è¿‡çš„â€œå®‰å…¨å…œåº•æ–¹æ¡ˆâ€**

---

### âœ… ä¿®æ­£æ–¹æ¡ˆ Aï¼šç»™ `read_mft_record` åŠ â€œå¤±è´¥è®¡æ•°â€

#### æ€è·¯

* è¿ç»­å¤±è´¥è¶…è¿‡é˜ˆå€¼
* è®¤ä¸º MFT æœ‰æ•ˆåŒºç»“æŸ
* **å®‰å…¨é€€å‡º**

---

### ğŸ”§ æ”¹ `enumerate()`ï¼ˆä½ ç°åœ¨å°±èƒ½ç”¨ï¼‰

```cpp
bool MFTReader::enumerate(
    const std::function<bool(const Entry&)>& callback) {

    std::vector<uint8_t> buffer(m_bytes_per_record);

    constexpr int MAX_CONSECUTIVE_FAIL = 32;
    int fail_count = 0;

    for (uint64_t i = 0; i < m_max_records; ++i) {

        if (!read_mft_record(i, buffer.data())) {
            if (++fail_count >= MAX_CONSECUTIVE_FAIL) {
                std::wcout << L"[!] Stop at record " << i
                           << L" due to read failures\n";
                break;
            }
            continue;
        }

        fail_count = 0; // âœ… æˆåŠŸå°±æ¸…é›¶

        auto* record =
            reinterpret_cast<NTFS_FILE_RECORD_HEADER*>(buffer.data());

        if (memcmp(record->signature, "FILE", 4) != 0)
            continue;

        if (!apply_fixup(buffer.data(),
                         static_cast<uint32_t>(m_bytes_per_record)))
            continue;

        if (!(record->flags & 0x01))
            continue;

        auto names = AttributeParser::parse_file_name(record);
        if (names.empty())
            continue;

        bool is_dir = AttributeParser::is_directory(record);
        uint64_t frn = i & 0x0000FFFFFFFFFFFFULL;

        for (const auto& n : names) {
            Entry e{};
            e.file_reference   = frn;
            e.parent_reference = n.parent_frn;
            e.name             = n.name;
            e.is_directory     = is_dir;

            if (!callback(e))
                return false;
        }

        if ((i % 100000) == 0) {
            std::wcout << L"Scanned " << i << L"\n";
        }
    }

    return true;
}
```

---

## äº”ã€ä¸ºä»€ä¹ˆè¿™ä¸ªæ–¹æ¡ˆæ˜¯â€œå¯¹çš„â€ï¼ˆè€Œä¸æ˜¯ hackï¼‰

âœ” Windows è‡ªå·±ä¹Ÿå…è®¸ `$MFT` ç¨€ç–
âœ” Everything æ—©æœŸç‰ˆæœ¬ç”¨è¿‡ç±»ä¼¼ç­–ç•¥
âœ” ä½ ä¸ä¼šæ¼æ‰**æœ‰æ•ˆè®°å½•**
âœ” ä½ ä¸ä¼šè¢«**æ— æ•ˆåŒºåŸŸå¡æ­»**

---

## å…­ã€ä¸‹ä¸€æ­¥ï¼ˆä½ å·²ç»ç«™åœ¨é—¨å£äº†ï¼‰

ä½ ç°åœ¨å·²ç»å®Œæˆï¼š

* âœ” çœŸæ­£è¯»å– `$MFT`
* âœ” ä¿®å¤ Fixup
* âœ” è§£æ FILE_NAME
* âœ” æ„å»º FRN æ ‘
* âœ” **è¸©åˆ°çœŸå® NTFS çš„å‘**

æ¥ä¸‹æ¥åªæœ‰ 3 æ¡è·¯ï¼ˆéƒ½æ˜¯çœŸ Everything è·¯çº¿ï¼‰ï¼š

1ï¸âƒ£ **è§£æ `$MFT::$DATA` çš„ RunListï¼ˆæ­£ç»Ÿè·¯çº¿ï¼‰**
2ï¸âƒ£ **ç”¨ USN Journal å¢é‡ç»´æŠ¤ï¼ˆEverything çš„æ ¸å¿ƒï¼‰**
3ï¸âƒ£ **ä¸¤è€…ç»“åˆï¼ˆEverything çœŸÂ·å®Œæ•´ç‰ˆï¼‰**

ä½ è¦å“ªä¸ªï¼Ÿ
æˆ‘å¯ä»¥ä¸€æ­¥æ­¥å¸¦ä½ å†™ã€‚
